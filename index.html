<!doctype html>
<html>
    <head>
        <script src="player.js"></script>
        <script src="mediafile.js"></script>
        <style>
            table {
                font-family:
                    JetBrainsMono Nerd Font Mono,
                    monospace;
                font-size: x-small;
            }
            th {
                text-align: left;
            }
        </style>
    </head>
    <body>
        <form>
            <input type="file" id="file_input" multiple />
            <input type="button" id="save_file_to_localdb" value="Save File" />
            <input type="button" id="list_localdb" value="List" />
        </form>

        <table id="stored_files"></table>
    </body>
    <script>
        var db;
        addEventListener("DOMContentLoaded", (evt) => {
            const DBOpenRequest = window.indexedDB.open("localplay", 3);
            DBOpenRequest.onerror = (evt) => {
                console.log(evt);
            };
            DBOpenRequest.onsuccess = (evt) => {
                db = DBOpenRequest.result;
                console.log(db);
            };
            DBOpenRequest.onupgradeneeded = (evt) => {
                db = evt.target.result;
                console.log("upgrade needed");
                const objStore = db.createObjectStore("mediaFiles", {
                    autoIncrement: true,
                });
            };

            let fl = document.getElementById("stored_files");
            let fi = document.getElementById("file_input");
            fi.addEventListener("change", (evt) => {
                console.log(evt);
            });

            let sb = document.getElementById("save_file_to_localdb");
            sb.addEventListener("click", (evt) => {
                // check if fi holds a file
                if (!fi.value) {
                    console.log("No file selected");
                    return;
                }

                for (let i = 0; i < fi.files.length; i++) {
                    // TODO use MediaFile
                    const mf = new MediaFile(
                        fi.files[i].name,
                        fi.files[i].type,
                        fi.files[i].lastModified,
                        fi.files[i].size,
                    );
                    const fr = new FileReader();
                    fr.onload = (evt) => {
                        const transaction = db.transaction(
                            "mediaFiles",
                            "readwrite",
                        );
                        const objSto = transaction.objectStore("mediaFiles", {
                            autoIncrement: true,
                        });

                        mf.data = fr.result;
                        const objStoReq = objSto.add(mf);
                        objStoReq.onsuccess = (evt) => {
                            console.log(mf);
                        };
                    };
                    fr.readAsArrayBuffer(fi.files[i]);
                }
            });
            let li = document.getElementById("list_localdb");
            let sf = document.getElementById("stored_files");
            li.addEventListener("click", (evt) => {
                const objSto = db
                    .transaction("mediaFiles")
                    .objectStore("mediaFiles");

                // clear filelist and add header
                // use a description "MediaFile"-like for setting the header
                sf.replaceChildren(
                    createTrFromMediaFile(
                        {
                            name: "Name",
                            lastModified: "Last Modified",
                            size: "Size",
                            type: "Type",
                        },
                        (hdr = true),
                    ),
                );

                objSto.openCursor().onsuccess = (evt) => {
                    const cursor = evt.target.result;
                    if (!cursor) {
                        return;
                    }
                    let mf = cursor.value;
                    mf.key = cursor.key;

                    // use the object... not really required...
                    Object.setPrototypeOf(mf, MediaFile.prototype);
                    console.log(mf instanceof MediaFile);

                    let tr = createTrFromMediaFile(mf);
                    sf.appendChild(tr);
                    cursor.continue();
                };
            });
        });
    </script>
</html>
